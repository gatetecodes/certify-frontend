<div class="grid grid-cols-1 gap-8 lg:grid-cols-12 items-start">
  <!-- Generation Form -->
  <aside class="lg:col-span-4 space-y-6">
    <div class="rounded-2xl border border-white/50 bg-white p-6 shadow-lg shadow-secondary/5">
      <div class="mb-6 flex items-center gap-3 border-b border-slate-100 pb-4">
        <div class="flex h-10 w-10 items-center justify-center rounded-full bg-secondary/10 text-secondary">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
            </svg>
        </div>
        <h2 class="text-lg font-bold text-slate-900">Generate Certificate</h2>
      </div>

      <div class="space-y-5">
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-2">Select Template</label>
          <div class="relative">
             <select
                [ngModel]="selectedTemplateId"
                (ngModelChange)="onTemplateChange($event)"
                name="templateId"
                class="w-full appearance-none rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-sm focus:border-primary focus:bg-white focus:outline-none focus:ring-1 focus:ring-primary"
            >
                <option [ngValue]="null">Choose a templateâ€¦</option>
                <option *ngFor="let t of templates" [ngValue]="t.id">
                {{ t.name }}
                </option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-500">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                    <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                </svg>
            </div>
          </div>
        </div>

        <ng-container *ngIf="selectedTemplateId">
          <div class="space-y-4 border-t border-slate-100 pt-4" *ngIf="templates.length">
            <ng-container *ngFor="let p of currentPlaceholders">
              <div>
                <label class="block text-xs font-bold uppercase tracking-wide text-slate-500 mb-1.5">
                  {{ p.label }}
                  <span *ngIf="p.required" class="text-red-500">*</span>
                </label>
                <input
                  [type]="p.type === 'date' ? 'date' : p.type === 'number' ? 'number' : 'text'"
                  [(ngModel)]="formData[p.key]"
                  [name]="p.key"
                  [required]="p.required"
                  class="w-full rounded-lg border border-slate-300 px-3 py-2.5 text-sm focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none"
                />
              </div>
            </ng-container>
             <div *ngIf="currentPlaceholders.length === 0" class="rounded-lg bg-secondary/10 p-3 text-center text-sm text-secondary-dark font-medium">
                This template has no dynamic fields.
            </div>
          </div>

          <div class="flex flex-col gap-2 pt-2">
            <div class="flex gap-3">
            <button
              type="button"
              (click)="simulate()"
              [disabled]="loading"
              class="flex-1 inline-flex justify-center items-center gap-2 rounded-lg border border-slate-200 bg-white px-4 py-2.5 text-sm font-bold text-slate-700 hover:bg-slate-50 hover:text-primary hover:border-primary/30 transition-all disabled:opacity-50"
            >
               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                <path d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z" />
                <path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 010-1.186A10.004 10.004 0 0110 3c4.257 0 8.142 2.383 9.336 6.41.172.584.172 1.195 0 1.78C18.142 15.166 14.257 17.55 10 17.55c-4.257 0-8.142-2.384-9.336-6.41zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
              </svg>
              Preview
            </button>
            <button
              type="button"
              (click)="generate()"
              [disabled]="loading"
              class="flex-1 inline-flex justify-center items-center gap-2 rounded-lg bg-primary px-4 py-2.5 text-sm font-bold text-white shadow-lg shadow-primary/25 hover:bg-primary-dark hover:shadow-xl transition-all disabled:opacity-50"
            >
               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" />
              </svg>
              Generate
            </button>
            <!-- <button
              type="button"
              (click)="generateAsync()"
              [disabled]="loading"
              class="flex-1 inline-flex justify-center items-center gap-2 rounded-lg bg-slate-900 px-4 py-2.5 text-sm font-bold text-white shadow-lg shadow-slate-400/40 hover:bg-black hover:shadow-xl transition-all disabled:opacity-50"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
                class="w-4 h-4"
              >
                <path
                  fill-rule="evenodd"
                  d="M4.5 2.75A.75.75 0 015.25 2h4a.75.75 0 01.53.22l5 5a.75.75 0 010 1.06l-4 4a.75.75 0 01-1.28-.53V10.5H5.25A.75.75 0 014.5 9.75v-7zM3.5 13.75a.75.75 0 011.5 0v2.5A1.75 1.75 0 006.75 18h8.5a1.75 1.75 0 001.75-1.75v-2.5a.75.75 0 011.5 0v2.5A3.25 3.25 0 0115.25 18h-8.5A3.25 3.25 0 013.5 16.25v-2.5z"
                  clip-rule="evenodd"
                />
              </svg>
              Async generate
            </button> -->
            </div>
          </div>
        </ng-container>

        <div *ngIf="!selectedTemplateId" class="flex flex-col items-center justify-center py-8 text-center">
            <div class="bg-slate-100 rounded-full p-3 mb-2 text-slate-400">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6">
                    <path fill-rule="evenodd" d="M4.5 2A2.5 2.5 0 002 4.5v2.879a2.5 2.5 0 00.732 1.767l4.5 4.5a2.5 2.5 0 003.536 0l2.878-2.878a2.5 2.5 0 000-3.536l-4.5-4.5A2.5 2.5 0 007.38 2H4.5zM10 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                    <path d="M15.75 2.75a.75.75 0 00-1.5 0V6h-3.25a.75.75 0 000 1.5h3.25v3.25a.75.75 0 001.5 0V7.5h3.25a.75.75 0 000-1.5h-3.25V2.75z" />
                 </svg>
            </div>
            <p class="text-sm text-slate-500">Select a template to start generating.</p>
        </div>
      </div>

      <div *ngIf="error" class="mt-3 rounded-lg bg-red-50 p-3 flex items-start gap-3">
         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-red-500 shrink-0">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
         </svg>
        <p class="text-sm text-red-600">{{ error }}</p>
      </div>
    </div>
  </aside>

  <!-- List -->
  <div class="lg:col-span-8">
    <div class="rounded-2xl border border-white/50 bg-white shadow-lg shadow-secondary/5">
      <div class="border-b border-slate-100 px-6 py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
             <div class="flex h-10 w-10 items-center justify-center rounded-full bg-secondary/10 text-secondary">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" />
                </svg>
            </div>
            <h2 class="text-lg font-bold text-slate-900">Issued Certificates</h2>
        </div>
        <span class="text-xs font-medium text-slate-500 bg-slate-100 px-2.5 py-1 rounded-full" *ngIf="certificates.length">
            {{ certificates.length }} Total
        </span>
      </div>

      <div class="overflow-x-auto pb-40">
        <table class="w-full text-left text-sm">
          <thead class="bg-slate-50/80 text-slate-500 border-b border-slate-100">
            <tr>
              <th class="px-6 py-4 font-semibold">ID</th>
              <th class="px-6 py-4 font-semibold">Template</th>
              <th class="px-6 py-4 font-semibold">Status</th>
              <th class="px-6 py-4 font-semibold">Issued At</th>

              <th class="px-6 py-4 font-semibold text-right">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100 bg-white">
            <tr *ngFor="let c of certificates" class="group hover:bg-slate-50 transition-colors">
              <td class="px-6 py-4 font-mono text-xs text-slate-600">
                  <span class="bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">{{ c.id | slice : 0 : 8 }}</span>
              </td>
              <td class="px-6 py-4">
                  <div class="font-medium text-slate-900">
                    {{ templateName(c.templateId) }}
                  </div>
              </td>
              <td class="px-6 py-4">
                <span
                  class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-xs font-medium"
                  [ngClass]="{
                    'bg-emerald-50 text-emerald-700 border border-emerald-200':
                      c.status === 'GENERATED',
                    'bg-red-50 text-red-700 border border-red-200':
                      c.status === 'REVOKED',
                    'bg-slate-100 text-slate-600 border border-slate-200':
                      c.status !== 'GENERATED' && c.status !== 'REVOKED'
                  }"
                >
                  <span
                    class="h-1.5 w-1.5 rounded-full"
                    [ngClass]="{
                      'bg-emerald-500': c.status === 'GENERATED',
                      'bg-red-500': c.status === 'REVOKED',
                      'bg-slate-400':
                        c.status !== 'GENERATED' && c.status !== 'REVOKED'
                    }"
                  ></span>
                  {{ c.status }}
                </span>
              </td>
              <td class="px-6 py-4 text-slate-600">
                  <div class="flex items-center gap-1.5">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3.5 h-3.5 text-slate-400">
                        <path fill-rule="evenodd" d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2zm-1 5.5c-.69 0-1.25.56-1.25 1.25v6.5c0 .69.56 1.25 1.25 1.25h10.5c.69 0 1.25-.56 1.25-1.25v-6.5c0-.69-.56-1.25-1.25-1.25H4.75z" clip-rule="evenodd" />
                      </svg>
                      {{ c.createdAt | date : "mediumDate" }}
                  </div>
              </td>

              <td class="relative px-6 py-4 text-right">
                <button
                  type="button"
                  (click)="toggleActions(c)"
                  class="inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-2.5 py-1.5 text-xs font-medium text-slate-600 hover:bg-slate-50 hover:text-slate-900 hover:border-slate-300 transition-colors"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                    class="w-4 h-4"
                  >
                    <path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z" />
                  </svg>
                </button>

                <div
                  *ngIf="openActionsId === c.id"
                  class="absolute right-6 mt-2 w-40 rounded-lg border border-slate-200 bg-white shadow-lg shadow-slate-200/60 z-10"
                >
                  <button
                    type="button"
                    (click)="openVerification(c)"
                    [disabled]="!c.verificationUrl || c.status !== 'GENERATED'"
                    class="flex w-full items-center gap-2 px-3 py-2 text-xs text-slate-700 hover:bg-slate-50 disabled:opacity-40 disabled:cursor-not-allowed"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                      class="w-3.5 h-3.5"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M16.403 12.652a3 3 0 000-5.304 3 3 0 00-3.75-3.751 3 3 0 00-5.305 0 3 3 0 00-3.751 3.75 3 3 0 000 5.305 3 3 0 003.75 3.751 3 3 0 005.305 0 3 3 0 003.75-3.751zm-2.546-4.46a.75.75 0 00-1.214-.883l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    <span>Verify</span>
                  </button>
                  <button
                    type="button"
                    (click)="download(c)"
                    [disabled]="c.status !== 'GENERATED'"
                    class="flex w-full items-center gap-2 px-3 py-2 text-xs text-slate-700 hover:bg-slate-50 disabled:opacity-40 disabled:cursor-not-allowed"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                      class="w-3.5 h-3.5 text-primary"
                    >
                      <path
                        d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.965 3.129V2.75z"
                      />
                      <path
                        d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z"
                      />
                    </svg>
                    <span>Download</span>
                  </button>
                  <button
                    *ngIf="auth.current?.role === 'TENANT_ADMIN'"
                    type="button"
                    (click)="revoke(c)"
                    [disabled]="c.status !== 'GENERATED'"
                    class="flex w-full items-center gap-2 px-3 py-2 text-xs text-red-600 hover:bg-red-50 disabled:opacity-40 disabled:cursor-not-allowed"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                      class="w-3.5 h-3.5"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    <span>Revoke</span>
                  </button>
                </div>
              </td>
            </tr>
             <tr *ngIf="certificates.length === 0">
                <td colspan="5" class="px-6 py-12 text-center">
                     <div class="mx-auto mb-3 flex h-12 w-12 items-center justify-center rounded-full bg-slate-100 text-slate-400">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                    </div>
                    <h3 class="text-sm font-semibold text-slate-900">No certificates issued</h3>
                    <p class="mt-1 text-xs text-slate-500">Generate a new certificate to see it listed here.</p>
                </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
